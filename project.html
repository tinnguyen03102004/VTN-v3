<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="VTN Architects - Project Detail">
    <title>Dự án - VTN Architects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=Inter:wght@300;400;500;600&family=Jost:wght@300;400;500;600;700&display=swap&subset=vietnamese"
        rel="stylesheet">
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="project-detail.css">
    <!-- Smooth Scroll -->
    <script src="https://unpkg.com/lenis@1.1.13/dist/lenis.min.js"></script>
</head>

<body class="project-page">
    <button class="lang-toggle" type="button" aria-label="Switch language"></button>

    <!-- Menu Toggle -->
    <button class="menu-toggle" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="scroll-progress"></div>

    <a href="index.html" class="back-button" id="backButton">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        <span data-i18n="project.back">Quay lại</span>
    </a>

    <header class="gallery-header header">
        <nav class="category-nav nav">
            <a href="index.html?filter=green" class="nav-link cat-link" data-i18n="nav.green">Xanh</a>
            <a href="index.html?filter=bamboo" class="nav-link cat-link" data-i18n="nav.bamboo">Tre</a>
            <a href="about.html" class="nav-link cat-link" data-i18n="nav.about">Giới thiệu</a>
        </nav>
        <a href="index.html" class="header-logo logo" aria-label="VTN Architects">
            <img src="projects/logo_VTN.png" alt="VTN Architects" class="logo-image" loading="lazy">
        </a>
    </header>

    <main class="main-content">
        <section class="project-header">
            <h1 class="project-title" id="projectTitle"></h1>
        </section>

        <section class="project-gallery">
            <div class="gallery-grid" id="projectGallery" aria-label="Project gallery"></div>
        </section>

        <section class="project-info">
            <div class="project-description">
                <div id="projectLead" class="project-lead"></div>
            </div>

            <div class="project-meta">
                <div class="meta-group">
                    <span class="meta-label" data-i18n="project.meta.location">Địa điểm</span>
                    <span class="meta-value" id="projectLocation"></span>
                </div>
                <div class="meta-group">
                    <span class="meta-label" data-i18n="project.meta.year">Năm hoàn thành</span>
                    <span class="meta-value" id="projectYear"></span>
                </div>
                <div class="meta-group">
                    <span class="meta-label" data-i18n="project.meta.awards">Giải thưởng</span>
                    <span class="meta-value meta-value--multiline" id="projectAward"></span>
                </div>
            </div>
        </section>
    </main>

    <!-- Full Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay">
        <nav class="menu-content">
            <ul class="menu-list">
                <li><a href="index.html" class="menu-link" data-i18n="menu.projects">Dự án</a></li>
                <li><a href="about.html#profile" class="menu-link" data-i18n="menu.about">Giới thiệu</a></li>
                <li><a href="about.html#people" class="menu-link" data-i18n="menu.people">Nhân sự</a></li>
                <li><a href="about.html#contact" class="menu-link" data-i18n="menu.contact">Liên hệ</a></li>
            </ul>
        </nav>
    </div>

    <script src="i18n.js"></script>
    <script src="projects-data.js"></script>
    <script src="project-detail.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const paramId = urlParams.get('id');
            let projectId = paramId;

            if (!projectId) {
                try {
                    projectId = sessionStorage.getItem('vtn-project-id');
                } catch { }
            }

            if (!projectId || !PROJECTS_DATA[projectId]) {
                projectId = PROJECTS_DATA['house-for-trees']
                    ? 'house-for-trees'
                    : Object.keys(PROJECTS_DATA)[0];
            }

            if (!paramId && projectId && window.history && window.history.replaceState) {
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.set('id', projectId);
                    window.history.replaceState({}, '', url.toString());
                } catch { }
            }



            const project = PROJECTS_DATA[projectId];

            if (!project) {
                console.error('Project not found:', projectId);
                // Optionally redirect to index or show error
                return;
            }

            const titleEl = document.getElementById('projectTitle');
            const metaAward = document.getElementById('projectAward');
            const lead = document.getElementById('projectLead');
            const galleryContainer = document.getElementById('projectGallery');

            function getLang() {
                return window.vtnGetLang ? window.vtnGetLang() : 'vi';
            }

            function projectTitle(lang) {
                return lang === 'vi' ? (project.titleVi || project.title) : project.title;
            }

            function projectLocation(lang) {
                if (lang === 'vi') return project.locationFull || project.location || '';
                return project.locationFullEn || project.locationEn || project.locationFull || project.location || '';
            }

            function projectAwards(lang) {
                const list = (lang === 'vi') ? (project.awards || []) : (project.awardsEn || project.awards || []);
                return Array.isArray(list) ? list : [];
            }

            function projectDescription(lang) {
                if (lang === 'vi') return project.description || '';
                return project.descriptionEn || project.description || '';
            }

            function imageAlt(title, lang, idx) {
                return lang === 'vi' ? `${title} - Hình ${idx + 1}` : `${title} image ${idx + 1}`;
            }

            function setMetaValue(id, value) {
                const el = document.getElementById(id);
                if (!el) return;
                const group = el.closest('.meta-group');
                const text = value == null ? '' : String(value).trim();

                if (!text) {
                    if (group) group.hidden = true;
                    return;
                }

                if (group) group.hidden = false;
                el.textContent = text;
            }

            // Back button category (for history/nav)
            const backButton = document.getElementById('backButton');
            if (backButton) backButton.dataset.category = project.category || 'green';

            function render(lang) {
                const title = projectTitle(lang) || 'Project';

                if (titleEl) titleEl.textContent = title;
                setMetaValue('projectLocation', projectLocation(lang));
                setMetaValue('projectYear', project.year);

                if (metaAward) {
                    const awardText = projectAwards(lang).join('<br>');
                    metaAward.innerHTML = awardText;
                    const group = metaAward.closest('.meta-group');
                    if (group) group.hidden = !awardText;
                }

                if (lead) {
                    lead.innerHTML = '';
                    const text = projectDescription(lang).trim();
                    if (text) {
                        const p = document.createElement('p');
                        p.textContent = text;
                        lead.appendChild(p);
                    }
                }

                const images = Array.isArray(project.gallery) ? project.gallery : [];
                if (galleryContainer) {
                    galleryContainer.innerHTML = images.map((src, idx) => {
                        const delay = Math.min(idx * 0.05, 0.4).toFixed(2);
                        const alt = imageAlt(title, lang, idx);

                        return `
                            <div class="gallery-item" data-scroll data-scroll-delay="${delay}">
                                <img src="${src}" alt="${alt}" class="gallery-image" loading="lazy" decoding="async">
                            </div>
                        `;
                    }).join('');
                }

                if (window.vtnInitLightbox) window.vtnInitLightbox();
                if (window.vtnInitScroll) window.vtnInitScroll();
                if (window.lenis) window.lenis.update();

                document.title = `${title} - VTN Architects`;
            }

            let lastLang = null;

            function syncLanguage(nextLang) {
                const lang = nextLang || (window.vtnGetLang ? window.vtnGetLang() : 'en');
                if (!lang || lang === lastLang) return;
                lastLang = lang;
                console.log('Project rendering language:', lang);
                render(lang);
            }

            // Wait for i18n to be fully initialized
            function initRender() {
                if (window.vtnGetLang) {
                    syncLanguage(window.vtnGetLang());
                } else {
                    // Fallback: try again after a short delay
                    setTimeout(() => {
                        syncLanguage(window.vtnGetLang ? window.vtnGetLang() : 'en');
                    }, 100);
                }
            }

            // Initial render with delay to ensure i18n is ready
            setTimeout(initRender, 50);

            // Listen for language changes from i18n system
            document.addEventListener('vtn:lang', (e) => {
                if (e && e.detail && e.detail.lang) {
                    syncLanguage(e.detail.lang);
                }
            });
        });
    </script>
</body>

</html>